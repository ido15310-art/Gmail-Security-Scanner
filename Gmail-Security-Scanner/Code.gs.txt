/**
 * ×¤×•× ×§×¦×™×™×ª ×”×›× ×™×¡×” ×”×¨××©×™×ª - ××©×¨ ××•×¡×¤×ª ××ª × ×ª×•× ×™ ×”××™×™×œ ×•×”××©×ª××© ××”×¢× ×Ÿ, ×•×× ×”×œ×ª ××ª ×¡×“×¨ ×”×¤×¢×•×œ×•×ª ×¢×“ ×œ×”×¦×’×ª ×”×ª×•×¦××” ×”×¡×•×¤×™×ª ×¢×œ ×”××¡×š
 */
function buildAddOn(e) 
{
  var accessToken = e.gmail.accessToken;
  GmailApp.setCurrentMessageAccessToken(accessToken); // ×§×‘×œ×ª ××¤×ª×— ×’×™×©×” ×–×× ×™ ×œ×§×¨×™××ª ×”××™×™×œ ×‘×¦×•×¨×” ×××•×‘×˜×—×ª
  var messageId = e.gmail.messageId;
  var message = GmailApp.getMessageById(messageId);// ×©×œ×™×¤×ª ×”××™×™×œ ×”××œ× ××”×©×¨×ª ×©×œ ×’×•×’×œ ×œ×¤×™ ×”-ID ×©×œ×•
  var senderRaw = message.getFrom();
  var sender = senderRaw.replace(/^.*<(.+)>.*$/, '$1');// ×©××™×¨×ª ×›×ª×•×‘×ª ×”×©×•×œ×—
  var props = PropertiesService.getUserProperties();// ×¤×ª×™×—×ª ××§×•× ×‘×¢× ×Ÿ ×œ×©×œ×™×¤×ª × ×ª×•× ×™×
  var blacklistStr = props.getProperty('blacklist') || "";
  var isBlacklisted = blacklistStr.split(",").indexOf(sender) !== -1;// ×‘×“×™×§×” ×”×× ×”×©×•×œ×— ×›×‘×¨ × ××¦× ×‘×¨×©×™××” ×”×©×—×•×¨×” ×©×œ× ×•
  var analysis = analyzeEmail(message, isBlacklisted);  // × ×™×ª×•×— ×”××™×™×œ ×¢"×¤ ×”×§×¨×˜×¨×™×•× ×™×
  var isRepeatOffender = props.getProperty("flagged_" + sender) === "true";// ×‘×•×“×§ ×”×× ×”×©×•×œ×— ×›×‘×¨ ×©×œ×— ×¤×¢× ×”×•×“×¢×”
  if (analysis.score >= 40) // ×× ×”×©×•×œ×— ×©×©×œ×— ×¤×¢× ×”×•×“×¢×” ×§×™×‘×œ ×¦×™×•×Ÿ ××¢×œ 40 ×™×§×¤×™×¥ ××–×”×¨×” ×œ××©×ª××©
  {
    props.setProperty("flagged_" + sender, "true");
  }
  return createUI(analysis, sender, isBlacklisted, isRepeatOffender);  //  ×‘× ×™×™×ª ×”×××©×§ ×•×”×¢×‘×¨×ª ×›×œ ×”× ×ª×•× ×™× 

}

/**
 * ×¡×•×¨×§ ××™××™×™×œ ×œ××™×ª×•×¨ ×¤×™×©×™× ×’ ×¢×œ ×™×“×™ × ×™×ª×•×— ××™×œ×•×ª ××¤×ª×—, ×§×™×©×•×¨×™× ×œ× ×××•×‘×˜×—×™× (HTTP) ×•×§×‘×¦×™× ××¦×•×¨×¤×™× ××¡×•×›× ×™×.
 */
function analyzeEmail(message, isBlacklisted) {
  var score = 0;
  var reasons = [];// ××ª×—×•×œ ××©×ª× ×™×, ×¦×™×•×Ÿ ××ª×—×™×œ ×-0 ×•×¡×™×‘×•×ª ×¨×™×§×”
  if (isBlacklisted)// ×‘×“×™×§×” ×”×× ×”×©×•×œ×— ×›×‘×¨ × ××¦× ×‘×¨×©×™××” ×”×©×—×•×¨×”, ×× ×›×Ÿ ××™×Ÿ ×˜×¢× ×œ×”××©×™×š ×‘×“×™×§×” ×”×¦×™×•×Ÿ ×©×œ×• ×™×”×™×” 100
  {
    return { score: 100, verdict: "Blocked by you ğŸš«", explanation: "Sender is in your blacklist" };
  }
  var subject = (message.getSubject() || "").toLowerCase();
  var body = (message.getPlainBody() || "").toLowerCase();
  var fullText = subject + " " + body;// ××ª×—×•×œ ××©×ª× ×™× ×©××›×™×œ×™× ××ª ×”× ×•×©× ×•××ª ×”×ª×•×›×Ÿ ×•×”×¢×‘×¨×ª× ×œ××©×ª× ×” ××—×“ ×›×“×™ ×œ×¦××¦× ×‘×“×™×§×•×ª
  var urgencyWords = ["urgent","action required", "immediately", "expired", "×“×—×•×£", "×¤×¢×•×œ×” × ×“×¨×©×ª","××™×™×“×™", "×¤×’ ×ª×•×§×£"];
  var rewardWords = ["winner", "lottery", "gift card", "free", "×¤×¨×¡", "××ª× ×”","×–×›×™×ª","×”×’×¨×œ×”","×›×¨×˜×™×¡ ××ª× ×”", "×—×™× ×"];
  var financeWords = ["bank", "paypal", "invoice", "payment", "crypto","×‘× ×§","×—×©×‘×•× ×™×ª", "×ª×©×œ×•×","×§×¨×™×¤×˜×•"];
  // ××¢×¨×›×™ ××™×œ×™× ××—×©×™×“×•×ª ×‘× ×•×©××™ ×“×—×™×¤×•×ª ×¤×¨×¡×™× ×•×¤×™× × ×¡×™× (× ×™×ª×Ÿ ×œ×”×’×“×™×œ ××ª ××¢×¨×›×™ ×”××™×œ×™× ×•×œ×™×™×¦×¨ ×™×•×ª×¨ ××¤×©×¨×•×™×•×ª ×œ×¦×‘×™×¨×ª ×”× ×™×§×•×“)
  urgencyWords.forEach(function(word)// ×œ×•×œ××” ×©××–×”×” ××™×œ×™× ×”××¤×¢×™×œ×•×ª ×œ×—×¥ ×•×™×•×¦×¨×•×ª ×ª×—×•×©×ª ×“×—×™×¤×•×ª
  {
    if (fullText.includes(word))
    { 
      score += 25; 
      reasons.push("High urgency detected (" + word + ")"); 
    }
  });
  rewardWords.forEach(function(word)// ×œ×•×œ××” ×©××–×”×” × ×™×¡×™×•× ×•×ª ×¤×™×ª×•×™ ×‘×××¦×¢×•×ª ×”×‘×˜×—×ª ×¤×¨×¡×™× ××• ××ª× ×•×ª
  {
    if (fullText.includes(word)) 
    {
       score += 25;
       reasons.push("Potential bait/reward detected (" + word + ")"); 
    }
  });
  financeWords.forEach(function(word)// ×œ×•×œ××” ×©×¡×•×¨×§×ª ××™×œ×™× ×”×§×©×•×¨×•×ª ×œ×›×¡×£ ×•×—×©×‘×•× ×•×ª ×‘× ×§ ×¨×’×™×©×™×
  {
    if (fullText.includes(word)) 
    { 
      score += 15;
      reasons.push("Sensitive financial topic (" + word + ")"); 
    }
  });
  if (body.includes("http://")) //  ×‘×“×™×§×” ×”×× ×™×© ×§×™×©×•×¨×™× ×—×©×•×“×™× ×›×œ× ×××•×‘×˜×—×™× ×‘×’×•×£ ×”××™×™×œ
  {
    score += 40;
    reasons.push("Insecure link detected (HTTP)");
  } 
  var attachments = message.getAttachments(); // ×©×•×œ×£ ××ª ×¨×©×™××ª ×”×§×‘×¦×™× ×”××¦×•×¨×¤×™×
  attachments.forEach(function(attachment) // ×œ×•×œ××” ×©×¨×¦×” ×¢×œ ××¢×¨×š ×”×§×‘×¦×™× ×”××¦×•×¨×¤×™×
  {
    var fileName = attachment.getName().toLowerCase(); // ×œ×•×§×— ××ª ×©× ×”×§×•×‘×¥
    if (fileName.endsWith(".exe") || fileName.endsWith(".zip")) {
      score += 50;
      reasons.push("Dangerous file attached: " + fileName);
    }
  });
  var uniqueReasons = reasons.filter(function(item, pos) // × ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª ×‘×”×¡×‘×¨×™×
  { 
    return reasons.indexOf(item) == pos; 
  });
  score = Math.min(score, 100);// × ×¨××•×œ ×”×¦×™×•×Ÿ
  var verdict = score >= 70 ? "Highly Dangerous âŒ" : (score >= 40 ? "Suspicious âš ï¸" : "Safe âœ…");// ×¤×¡×§ ×”×“×™×Ÿ
  return {
    score: score,
    verdict: verdict,
    explanation: uniqueReasons.length > 0 ? uniqueReasons.join(", ") : "No threats detected"};
}

/**
 * ×‘× ×™×™×ª ×”×××©×§ ×”××•×¦×’ ×œ××©×ª××©
 */
function createUI(analysis, sender, isBlacklisted, isRepeatOffender) {
  var card = CardService.newCardBuilder();// ×”×›× ×ª ×“×£ ×”×ª×¦×•×’×”
  card.setHeader(CardService.newCardHeader().setTitle("Upwind Scanner"));// ×›×•×ª×¨×ª
  var section = CardService.newCardSection();
  
  // ×©×™××•×© ×‘×ª×’×™×•×ª <b> ×œ×”×“×’×©×” ×‘×ª×•×š ×”×××©×§
  section.addWidget(CardService.newTextParagraph().setText("<b>Score:</b> " + analysis.score + "/100"));  // ×”×¦×’×ª × ×™×§×•×“ ×”×¡×™×›×•×Ÿ
  section.addWidget(CardService.newTextParagraph().setText("<b>Status:</b> " + analysis.verdict));// ×”×¦×’×ª ×¤×¡×§ ×“×™×Ÿ ×”×¡×•×¤×™
  section.addWidget(CardService.newTextParagraph().setText("<b>Analysis:</b> " + analysis.explanation));// ×”×¦×’×ª ×¨×©×™××ª ×”×¡×›×•× ×™× ×©×–×•×”×• 
  
  if (isRepeatOffender) // ×”×¦×’×ª ××–×”×¨×ª ×”×™×¡×˜×•×¨×™×”
  {
    section.addWidget(CardService.newTextParagraph().setText("âš ï¸ <b>Note:</b> This sender was flagged in previous scans."));
  }
  
  var action = CardService.newAction().setFunctionName(isBlacklisted ? 'removeFromBlacklist' : 'addToBlacklist').setParameters({sender: sender});   // ×‘×“×™×§×” ×”×× ×”×©×•×œ×— × ××¦× ×›×‘×¨ ×‘×¨×©×™××” ×”×©×—×•×¨×”
  section.addWidget(CardService.newTextButton().setText(isBlacklisted ? "âœ… Mark as Safe" : "ğŸš« Block Sender").setOnClickAction(action));// ×™×¦×™×¨×ª ×›×¤×ª×•×¨ ×—×¡×™××” ××• ×©×—×¨×•×¨ - ×”×˜×§×¡×˜ ××©×ª× ×” ×œ×¤×™ ××¦×‘ ×”×©×•×œ×— (×—×¡×•× ××• ×œ×)
  section.addWidget(CardService.newTextButton().setText("ğŸ“œ View Blacklist").setOnClickAction(CardService.newAction().setFunctionName('showFullBlacklist')));// ×™×¦×™×¨×ª ×›×¤×ª×•×¨ ×œ×¤×ª×™×—×ª ×”×¨×©×™××” ×”×©×—×•×¨×” ×”××œ××” ×©×œ ×”××©×ª××©
  
  card.addSection(section); // ×”×•×¡×¤×ª ×”×ª×•×›×Ÿ ×œ×“×£ ×”×ª×•×¡×£
  return card.build();
}

/**
 * ×¤×•× ×§×¦×™×ª ×”×•×¡×¤×” ×œ×¨×©×™××” ×”×©×—×•×¨×”
 */
function addToBlacklist(e) {
  var sender = e.parameters.sender;
  var props = PropertiesService.getUserProperties();
  var blacklist = props.getProperty('blacklist') || "";
  if (blacklist.indexOf(sender) === -1) {
    props.setProperty('blacklist', blacklist + (blacklist ? "," : "") + sender);
  }
  
  var notification = CardService.newNotification().setText("Sender blocked successfully");// ×”×•×“×¢×” ×§×•×¤×¦×ª
  var navigation = CardService.newNavigation().updateCard(buildAddOn(e)); // ×‘×•× ×” ××ª ×”×›×¨×˜×™×¡ ××—×“×©
  
  var response = CardService.newActionResponseBuilder();// ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×ª×’×•×‘×” ×©×™×™×©×œ×— ×‘×—×–×¨×” ×œ×’'×™××™×™×œ
  response.setNotification(notification); // ×”×•×¡×¤×ª ×”×•×“×¢×ª ××™×©×•×¨ ×§×•×¤×¦×ª
  response.setNavigation(navigation);// ×”×•×¨××” ×œ×××©×§ ×œ×”×ª×¨×¢× ×Ÿ ×•×œ×”×¦×™×’ ××ª ×”×›×¨×˜×™×¡ ×”××¢×•×“×›×Ÿ (×œ××©×œ, ×©×™× ×•×™ ×”×›×¤×ª×•×¨ ×'×—×¡×™××”' ×œ'×©×—×¨×•×¨')
  
  return response.build();// ×”×—×–×¨×ª ×”×ª×©×•×‘×”
}

/**
 * ×¤×•× ×§×¦×™×ª ×”×¡×¨×” ××”×¨×©×™××” ×”×©×—×•×¨×”
 */
function removeFromBlacklist(e) {
  var sender = e.parameters.sender;
  var props = PropertiesService.getUserProperties();
  var list = (props.getProperty('blacklist') || "").split(",");
  var newList = list.filter(function(item)// ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×” ×©××™× ×” ×›×•×œ×œ×ª ××ª ×”×©×•×œ×— ×”× ×•×›×—×™
  { 
    return item !== sender; 
  });
  props.setProperty('blacklist', newList.join(","));// ×©××™×¨×ª ×”×¨×©×™××” ×”××¢×•×“×›× ×ª ×œ××—×¨ ×©×”×¤×›× ×• ××•×ª×” ×©×•×‘ ×œ××—×¨×•×–×ª ×¢× ×¤×¡×™×§×™×
  
  var notification = CardService.newNotification().setText("Sender marked as safe"); // ×™×¦×™×¨×ª ×”×”×•×“×¢×” ×”×§×•×¤×¦×ª (Notification) ×©×ª××©×¨ ×œ××©×ª××© ×©×”×¤×¢×•×œ×” ×”×¦×œ×™×—×”
  var navigation = CardService.newNavigation().updateCard(buildAddOn(e));// ×™×¦×™×¨×ª ×¤×§×•×“×ª ×”× ×™×•×•×˜ (Navigation) ×©×ª×¢×“×›×Ÿ ××ª ×”×›×¨×˜×™×¡ ×”× ×•×›×—×™
  
  var response = CardService.newActionResponseBuilder();// ×‘× ×™×™×ª ×”×ª×’×•×‘×” ×”×¡×•×¤×™×ª (ActionResponse) ×©×××—×“×ª ××ª ×”×”×•×“×¢×” ×•××ª ×¢×“×›×•×Ÿ ×”××¡×š
  response.setNotification(notification);
  response.setNavigation(navigation);
  
  return response.build(); // ×©×œ×™×—×ª ×”×ª×©×•×‘×” ×”××•×›× ×” ×œ×’'×™××™×™×œ
}

/**
 * ×¤×•× ×§×¦×™×” ×”××¦×™×’×” ×“×£ ×—×“×© ×¢× ×›×œ ×¨×©×™××ª ×”×›×ª×•×‘×•×ª ×”×—×¡×•××•×ª
 */
function showFullBlacklist() {
  var blacklist = PropertiesService.getUserProperties().getProperty('blacklist');
  var listDisplay = blacklist ? blacklist.replace(/,/g, "\n") : "Your blacklist is currently empty.";//×©×œ×™×¤×ª ×”×¨×©×™××” ××”×–×™×›×¨×•×Ÿ. ×× ×”×™× ×¨×™×§×”, × ×¦×™×’ ×”×•×“×¢×” ××ª××™××”
  
  var card = CardService.newCardBuilder();//  ×‘× ×™×™×ª ×”×›×¨×˜×™×¡ (×”×“×£ ×”×—×“×©)
  card.setHeader(CardService.newCardHeader().setTitle("Full Blacklist"));
  
  var section = CardService.newCardSection();
  section.addWidget(CardService.newTextParagraph().setText(listDisplay));// ×”×•×¡×¤×ª ×¨×©×™××ª ×”××™×™×œ×™× ×›×¤×¡×§×” (×›×œ ××™×™×œ ×‘×©×•×¨×” ×—×“×©×” ×‘×–×›×•×ª ×”-replace)
  section.addWidget(CardService.newTextButton().setText("â¬…ï¸ Back").setOnClickAction(CardService.newAction().setFunctionName('goBack'))); // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×“×£ ×”×¨××©×™
  
  card.addSection(section);
  return CardService.newNavigation().pushCard(card.build());// ×™×¦×™×¨×ª ×¤×§×•×“×ª × ×™×•×•×˜ ××¡×•×’ "Push" - ×¤×ª×™×—×ª ×“×£ ×—×“×© ××¢×œ ×”×“×£ ×”× ×•×›×—×™
}

/**
 * ×¤×•× ×§×¦×™×” ×¤×©×•×˜×” ×©×¡×•×’×¨×ª ××ª ×”×›×¨×˜×™×¡ ×”× ×•×›×—×™ ×•××—×–×™×¨×” ××•×ª× ×• ××—×•×¨×”
 */
function goBack() {
  return CardService.newNavigation().popCard();
}
